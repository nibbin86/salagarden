zjs.require("ui.button",function(){zjs.extendCore({moduleUiButtonFileOption:{name:"",text:"Choose File",data:{},multiple:!0,autoupload:"ajax",autouploadUrl:"",autouploadClear:!0,uploadMultipleFilesAtOneTime:!0,maxFileSize:10485760,maxNumberOfFile:10,allowFileExt:"",notallowFileExt:"php,exe,asp",returntype:"json",uploadingText:"",dropText:""}});var k=function(){var a=!1;window.XMLHttpRequest&&(a=new window.XMLHttpRequest);var g=document.createElement("INPUT");g.type="file";var f=!!window.FormData;
return"files"in g&&a&&a.upload&&"onprogress"in a.upload&&f}(),r=function(a,g){var f=zjs(a),b=f.getData("zmoduleuibuttonfileoption");if(b)f.setData("zmoduleuibuttonfileoption",zjs.extend(b,g));else{var b=zjs.clone(zjs.moduleUiButtonFileOption),l=f.getAttr("data-option","");zjs.isString(l)&&""!=l.trim()&&(b=zjs.extend(b,l.jsonDecode()));f.removeAttr("data-option");"undefined"!=typeof g&&(b=zjs.extend(b,g));l=zjs.enablehook();zjs.enablehook(!1);var m=f.is("input")?"input":"a";if("input"!=m||f.is("[type=file]")){if("a"==
m)var h=zjs(a),c=zjs('<input type="file">');"input"==m&&(c=zjs(a),h=zjs("<a>").html(b.text).insertBefore(c));window.attachEvent&&c.attr("tabIndex",-1);if(b.multiple)try{c.item(0,!0).multiple=!0}catch(q){}"multiple"in c.item(0,!0)&&c.item(0,!0).multiple?b.multiple=!0:(b.multiple=!1,c.item(0,!0).multiple=!1);""==b.name&&""==c.getAttr("name","")&&c.attr("name","uploadfile");""!=b.name&&""==c.getAttr("name","")&&c.attr("name",b.name);b.multiple&&c.attr("name")&&!c.attr("name").test(/\[\]$/)&&c.attr("name",
c.attr("name")+"[]");b.name=c.attr("name");f.setData("zmoduleuibuttonfilebtnel",h);f.setData("zmoduleuibuttonfileinputel",c);""==b.dropText&&(b.dropText="Drop here to upload");h.makeButton().addClass("zui-button-file").style({position:"relative",overflow:"hidden",direction:"ltr"});c.appendTo(h).style({position:"absolute",right:"0px",top:"0px","font-family":"Arial","font-size":"118px",margin:"0px",padding:"0px","min-height":"100%","min-width":"100%",cursor:"pointer",opacity:0}).hover(function(){c.style("cursor",
h.hasClass("disabled")?"default":"pointer");h.addClass("hover")},function(){h.removeClass("hover active")}).on("mousedown",function(){h.addClass("active")}).on("mouseup",function(){h.removeClass("active")});""==b.autouploadUrl&&(b.autoupload="");"ajax"!=b.autoupload||k||(b.autoupload="form");"ajax"==b.autoupload&&k&&(b.uploadMultipleFilesAtOneTime=!!b.uploadMultipleFilesAtOneTime,h.addClass("zui-support-drag-drop").prepend('<span class="zui-button-drop-text">'+b.dropText+"</span>"),c.on("dragenter",
function(b){h.hasClass("disabled")||h.addClass("zui-ready-to-drop")}),c.on("dragleave",function(b){h.removeClass("zui-ready-to-drop")}),c.on("drop",function(b){h.removeClass("zui-ready-to-drop")}));f.setData("zmoduleuibuttonfileoption",b);f.setData("zmoduleuibuttonfilexhrs",[]);var n=h.find(".zui-button-label");c.on("change",function(g,c){b=f.getData("zmoduleuibuttonfileoption");var d=!1;try{d=g.original?g.original.target?g.original.target:g.original.srcElement?g.original.srcElement:!1:!1}catch(x){}if(d&&
"undefined"!=typeof d.files)for(var e=[],d=0;d<g.original.target.files.length;d++)t(g.original.target.files[d])&&e.push(u(g.original.target.files[d]));else if(c.files)for(e=[],d=0;d<c.files.length;d++)t(c.files[d])&&e.push(u(c.files[d]));else{var d="",l=0;c.value?d=c.value.replace(/.*(\/|\\)/,""):(d=null!=c.fileName?c.fileName:c.name,l=null!=c.fileSize?c.fileSize:c.size);e=[{name:d,size:l,upsize:0}]}try{f.trigger("ui.button.file.change",{files:e})}catch(y){zjs.log("your handler for event <b>ui.button.file.change</b> has error! (see console log)"),
console.log(y)}if(0<b.maxNumberOfFile&&e.length>b.maxNumberOfFile)try{f.trigger("ui.button.file.maxnumberoffile",{files:e})}catch(q){zjs.log("your handler for event <b>ui.button.file.maxnumberoffile</b> has error! (see console log)"),console.log(q)}else{l=[];if(""!=b.allowFileExt.trim())for(var m=b.allowFileExt.toLowerCase().split(/\s*,\s*/),d=0;d<e.length;d++)m.include(e[d].ext)||l.push(e[d]);if(""!=b.notallowFileExt.trim())for(m=b.notallowFileExt.toLowerCase().split(/\s*,\s*/),d=0;d<e.length;d++)m.include(e[d].ext)&&
l.push(e[d]);if(0<l.length)try{f.trigger("ui.button.file.wrongfileext",{files:l})}catch(p){zjs.log("your handler for event <b>ui.button.file.wrongfileext</b> has error! (see console log)"),console.log(p)}else{if(0<b.maxFileSize){l=[];for(d=0;d<e.length;d++)e[d].size>b.maxFileSize&&l.push(e[d]);if(0<l.length){try{f.trigger("ui.button.file.maxfilesize",{files:l})}catch(z){zjs.log("your handler for event <b>ui.button.file.maxfilesize</b> has error! (see console log)"),console.log(z)}return}}if("form"==
b.autoupload){try{f.trigger("ui.button.file.upload.begin",{files:e})}catch(A){zjs.log("your handler for event <b>ui.button.file.upload.begin</b> has error! (see console log)"),console.log(A)}h.addClass("zui-loading-icon","disabled");var k=n.getInnerHTML();""!=b.uploadingText&&(h.addClass("zui-loading-icon-with-text"),n.html(b.uploadingText.format({percent:0})));try{f.trigger("ui.button.file.upload.loading",{files:e,percent:0})}catch(r){zjs.log("your handler for event <b>ui.button.file.upload.loading</b> has error! (see console log)"),
console.log(r)}w(c,b.autouploadUrl,b.returntype,b.data,b,function(a){for(var d=0;d<e.length;d++)e[d].upsize=e[d].size;""!=b.uploadingText&&n.html(b.uploadingText.format({percent:100}));try{f.trigger("ui.button.file.upload.loading",{files:e,percent:100})}catch(g){zjs.log("your handler for event <b>ui.button.file.upload.loading</b> has error! (see console log)"),console.log(g)}try{f.trigger("ui.button.file.upload.complete",{files:e,response:a})}catch(l){zjs.log("your handler for event <b>ui.button.file.upload.complete</b> has error! (see console log)"),
console.log(l)}h.removeClass("zui-loading-icon","zui-loading-icon-with-text","disabled","hover");""!=b.uploadingText&&n.html(k);if(b.autouploadClear&&"-webkit-"==zjs.browser.cssprefix){try{c.files=null}catch(y){}try{c.value=null}catch(p){}try{c.fileName=null}catch(x){}}})}else if("ajax"==b.autoupload&&b.uploadMultipleFilesAtOneTime){try{f.trigger("ui.button.file.upload.begin",{files:e})}catch(B){zjs.log("your handler for event <b>ui.button.file.upload.begin</b> has error! (see console log)"),console.log(B)}h.addClass("zui-loading-icon").addClass("disabled");
k=n.getInnerHTML();""!=b.uploadingText&&h.addClass("zui-loading-icon-with-text");try{f.trigger("ui.button.file.upload.loading",{files:e,percent:0})}catch(C){zjs.log("your handler for event <b>ui.button.file.upload.loading</b> has error! (see console log)"),console.log(C)}D(c,b.autouploadUrl,b.returntype,b.data,b,function(a,d){for(var c=0;c<e.length;c++)e[c].upsize=e[c].size*d/100;""!=b.uploadingText&&n.html(b.uploadingText.format({percent:d}));try{f.trigger("ui.button.file.upload.loading",{files:e,
percent:d})}catch(g){zjs.log("your handler for event <b>ui.button.file.upload.loading</b> has error! (see console log)"),console.log(g)}},function(a,c){for(var d=0;d<e.length;d++)e[d].upsize=e[d].size;try{f.trigger("ui.button.file.upload.complete",{files:e,response:c})}catch(g){zjs.log("your handler for event <b>ui.button.file.upload.complete</b> has error! (see console log)"),console.log(g)}h.removeClass("zui-loading-icon","zui-loading-icon-with-text","disabled","hover");""!=b.uploadingText&&n.html(k)},
function(b){})}else"ajax"!=b.autoupload||b.uploadMultipleFilesAtOneTime||E(c,b.autouploadUrl,b.returntype,b.data,b,a,function(b,a,d){try{f.trigger("ui.button.file.upload.begin",{id:a,file:d})}catch(e){zjs.log("your handler for event <b>ui.button.file.upload.begin</b> has error! (see console log)"),console.log(e)}},function(b,a,d,e){try{f.trigger("ui.button.file.upload.loading",{id:a,file:d,percent:e})}catch(c){zjs.log("your handler for event <b>ui.button.file.upload.loading</b> has error! (see console log)"),
console.log(c)}},function(b,a,d,e){try{f.trigger("ui.button.file.upload.complete",{id:a,file:d,response:e})}catch(c){zjs.log("your handler for event <b>ui.button.file.upload.complete</b> has error! (see console log)"),console.log(c)}},function(b,a,d){try{f.trigger("ui.button.file.upload.abort",{id:a,file:d})}catch(e){zjs.log("your handler for event <b>ui.button.file.upload.abort</b> has error! (see console log)"),console.log(e)}})}}});zjs.enablehook(l)}}},t=function(a){try{return"object"==typeof a&&
a.constructor===File}catch(g){}return!1},u=function(a){return{name:a.name,size:a.size,upsize:0,ext:a.name.split(/\s*\.\s*/).pop().toLowerCase(),type:a.type}},w=function(){var a=0,g=zjs("<div>").appendTo("body").style({position:"fixed",top:-5E3,left:-5E3,opacity:0,display:"none"});return function(f,b,l,m,h,c){var q=zjs(f),n=q.parent();f="zjsautouploadform"+a++;h=zjs('<iframe src="javascript:false;" name="'+f+'" />').appendTo(g);var k=zjs("<form>").setAttr({method:"post",enctype:"multipart/form-data",
action:b,target:f}).appendTo(g);q.appendTo(k);zjs.foreach(m,function(b,a){zjs('<input type="hidden" name="'+a+'" value="'+b+'" />').appendTo(k)});h.on("load",function(b,a){if(a.parentNode&&(!a.contentDocument||!a.contentDocument.body||"false"!=a.contentDocument.body.innerHTML)){var f=a.contentDocument?a.contentDocument:a.contentWindow.document,e="";try{e=f.body.innerHTML}catch(g){}try{""!=e&&(e=e.stripTags().replace(/^[^\[{]*(\[|{)/,function(b,a){return a}))}catch(h){}try{""!=e&&(e=e.decodeEntities())}catch(k){}e||
(e="");"json"==l&&(e=e.jsonDecode());"function"==typeof c&&c.call(this,e);setTimeout(function(){zjs(a).remove()},1);n&&q.appendTo(n)}});k.submit();return!0}}(),D=function(a,g,f,b,l,m,h,c){if(!k)return!1;var q=new FormData;if(q){zjs.each(b,function(b,a){q.append(a,b)});b=0;var n;for(b=0;b<a.files.length;b++)t(a.files[b])&&(n=a.files[b],q.append(l.name,n));b=new XMLHttpRequest;b.onerror=function(b){};b.onreadystatechange=function(){};b.onload=function(b){var a="";this.responseText&&(a=this.responseText.replace(/[\n\r]/g,
""));"json"==f&&(a=a.jsonDecode());h(b,a)};b.upload.onprogress=function(b){var a=Math.round(100/b.total*b.loaded);m(b,a)};b.onabort=function(b){c(b)};b.open("POST",g);b.send(q);if(l.autouploadClear){try{a.files=null}catch(u){}try{a.value=null}catch(r){}try{a.fileName=null}catch(d){}}return!0}},E=function(a,g,f,b,l,m,h,c,q,n){if(!k)return!1;var r=zjs(m);zjs.each(a.files,function(a,d){if(t(a)){var k=zjs.getUniqueId(),m=u(a),v=new FormData;if(v){zjs.each(b,function(b,a){v.append(a,b)});v.append(l.name,
a);h(!1,k,m);var p=r.getData("zmoduleuibuttonfilexhrs",[]);zjs.isArray(p)||(p=[]);p[k]=new XMLHttpRequest;p[k].onerror=function(b){};p[k].onreadystatechange=function(){};p[k].onload=function(b){var a="";this.responseText&&(a=this.responseText.replace(/[\n\r]/g,""));"json"==f&&(a=a.jsonDecode());q(b,k,m,a)};p[k].upload.onprogress=function(a){var b=Math.round(100/a.total*a.loaded);m.upsize=a.loaded;c(a,k,m,b)};p[k].onabort=function(a){n(a,k,m)};r.setData("zmoduleuibuttonfilexhrs",p);p[k].open("POST",
g);p[k].send(v)}}});if(l.autouploadClear){try{a.files=null}catch(w){}try{a.value=null}catch(d){}try{a.fileName=null}catch(x){}}return!0};k&&(zjs(window).on("dragenter",function(a){zjs(document.body).addClass("zui-body-ready-to-drop")}),zjs(window).on("dragover",function(a){var g=zjs(a.toTarget()),f=!0;g?g.is("input[type=file]")||(f=!1):f=!1;f||(a.preventDefault(),a.stop());(a.original.clientX>window.innerWidth||a.original.clientY>window.innerHeight||0>=a.original.clientX||0>=a.original.clientY)&&
zjs(document.body).removeClass("zui-body-ready-to-drop")}),zjs(window).on("dragleave",function(a){(a.original.clientX>window.innerWidth||a.original.clientY>window.innerHeight||0>=a.original.clientX||0>=a.original.clientY)&&zjs(document.body).removeClass("zui-body-ready-to-drop")}),zjs(window).on("drop",function(a){var g=zjs(a.toTarget()),f=!0;g?g.is("input[type=file]")||(f=!1):f=!1;f||(a.preventDefault(),a.stop());zjs(document.body).removeClass("zui-body-ready-to-drop")}));zjs.extendCore({uploadFile:function(a){a=
zjs.extend({inputName:"uploadfile",fileLocation:"",uploadUrl:"",returnType:"json",data:{},callback:function(){}},a);var g=zjs('<input type="file" name="'+a.inputName+'" value="'+a.fileLocation+'" />');return 0>=g.count()?!1:w(g,a.uploadUrl,a.returnType,a.data,a.callback)}});zjs.extendMethod({makeButtonFile:function(a){return this.each(function(g){r(g,a)})},buttonFileSetData:function(a,g){return this.each(function(f){f=zjs(f);var b=f.getData("zmoduleuibuttonfileoption");b&&(b.data[a]=g,f.setData("zmoduleuibuttonfileoption",
b))})},buttonFileAbortUpload:function(a){return this.each(function(g){k&&(g=zjs(g),g.getData("zmoduleuibuttonfileoption")&&(g=g.getData("zmoduleuibuttonfilexhrs",[]),g[a]&&g[a].abort()))})}});zjs.hook({after_setInnerHTML:function(a){zjs(a).find(".zbuttonfile").makeButtonFile()},after_insertDOM:function(a){zjs(a).hasClass("zbuttonfile")&&zjs(a).makeButtonFile();zjs(a).find(".zbuttonfile").makeButtonFile()}});zjs.onready(function(){zjs(".zbuttonfile").makeButtonFile()});"required"in zjs&&zjs.required("ui.button.file")});